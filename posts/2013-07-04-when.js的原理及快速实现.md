## when.js的原理及快速实现

这篇文章可以看作是[屈屈](http://imququ.com)同学关于when.js的文章[《异步编程：When.js快速上手》](http://www.imququ.com/post/promises-when-js.html)的续篇。

屈屈的文章中详细介绍了when.js，在这里关于when.js的使用我就不多复述了，大家可以自己去研究它的API。

在这里，我主要想讨论的是如何实现一个when.js类似的promise/A框架。为了更清晰了解实现原理，我略过when.js中一些比较强大的功能，只实现其中最核心的功能，包括基本的then()，otherwise()以及比较好用的all()和any()。

<!--more-->

下面看一下Promise的基本数据结构：

```js
function Promise(){
  this._resolves = [];
  this._rejects = [];
  this._readyState = Promise.PENDING;
  this._data = null;
  this._reason = null;
}

mix(Promise, {
  PENDING : 0,
  FULFILLED : 1,
  REJECTED : 2,
  isPromise: function(obj){
    return obj != null &amp;&amp; typeof obj['then'] == 'function';
  }
});
```

我们可以看到，一个Promise包含五个属性，一个_resolves数组用来存放当状态转换为FULFILLED之时需要执行的动作，_rejects数组用来存放当状态转换为REJECTED时需要执行的动作，一个_readyState属性用来存放当前的Promise对象的状态，一个_data属性用来存放调用resolve时传递参数，一个_reason属性用来存放调用reject时传递的参数。

详细的参数说明我们继续看后面的实现会比较明白：

```js
mix(Promise.prototype, {
  then: function(onFulfilled, onRejected){
    var deferred = new Defer();
    function fulfill(data){
      var ret = onFulfilled ? onFulfilled(data) : data;
      if(Promise.isPromise(ret)){
        ret.then(function(data){
          deferred.resolve(data);
        });
      }else{
        deferred.resolve(ret);
      }
      return ret;
    }

    if(this._readyState === Promise.PENDING){
      this._resolves.push(fulfill);

      if(onRejected){
        this._rejects.push(onRejected);
      }else{
        //为了让reject向后传递
        this._rejects.push(function(reason){
          deferred.reject(reason);
        });
      }
    }else if(this._readyState === Promise.FULFILLED){
      var self = this;
      setTimeout(function(){
        fulfill(self._data);
      });
    }
    return deferred.promise;
  },
  otherwise: function(onRejected){
    return this.then(undefined, onRejected);
  }
});
```
